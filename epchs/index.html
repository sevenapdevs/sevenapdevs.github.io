<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Epsteins Kinder</title>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #eef2f7, #d9e4f5);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: auto;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        h1 {
            margin-top: 0;
            font-weight: 600;
        }

        #click-note {
            color: #666;
            margin-bottom: 15px;
        }

        button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        #reset-btn {
            background: #ff5c5c;
            color: white;
        }

        #reset-btn:hover {
            background: #e04848;
            transform: translateY(-2px);
        }

        ul {
            list-style-type: none;
            padding-left: 20px;
        }

        li {
            display: block;
            cursor: pointer;
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 10px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        li:hover {
            transform: translateX(4px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.1);
        }

        /* Floating Button */
        .sidebar {
            position: fixed;
            right: 25px;
            bottom: 25px;
        }

        .sidebar button {
            background: #4a7dfc;
            color: white;
            font-size: 15px;
            padding: 14px 20px;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .sidebar button:hover {
            background: #345ee8;
            transform: translateY(-3px);
        }

        .display-none {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">

        <div class="card">
            <h1>Epsteins Kinder</h1>
            <p id="click-note">(Click anywhere to start)</p>    
            <button id="reset-btn">Reset</button>
        </div>

        <div class="card">
            <ul id="eplst"></ul>
        </div>

    </div>

    <!-- Floating Button -->
    <div class="sidebar">
        <button id="floating-new-child">Neues Kind</button>
    </div>

    <script>
        let childsCounter = 1;
        let childsChildsMap = new Map();
        const STORAGE_KEY = "epstein_tree";

        function init(){
            document.addEventListener('click', addNewChild);

            document.getElementById('reset-btn')
                .addEventListener('click', resetList);

            document.getElementById('floating-new-child')
                .addEventListener('click', function(e){
                    e.stopPropagation();
                    addNewChild(e);
                });

            loadFromStorage();
        }

        function getRandomColor(){
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 80%)`;
        }

        function addNewChild(e){
            document.getElementById('click-note')
                .classList.add('display-none');

            let epLst = document.getElementById('eplst');
            let newChild = createNode("Epstein " + childsCounter, getRandomColor());

            childsCounter++;
            epLst.appendChild(newChild);

            saveToStorage();
        }

        function addChildsChild(e){
            e.stopPropagation();

            let parent = e.currentTarget;
            let childIndex = childsChildsMap.get(parent);

            let newChildList = parent.querySelector('ul');

            if (!newChildList){
                newChildList = document.createElement('ul');
                parent.appendChild(newChildList);
            }

            let newText = parent.firstChild.textContent + "-" + childIndex;
            let newChild = createNode(newText, parent.dataset.color);

            newChildList.appendChild(newChild);

            childsChildsMap.set(parent, childIndex + 1);

            saveToStorage();
        }

        function createNode(text, color){
            let li = document.createElement('li');
            li.textContent = text;

            li.style.backgroundColor = color;
            li.dataset.color = color;

            li.addEventListener('click', addChildsChild);

            childsChildsMap.set(li, 1);

            return li;
        }

        function resetList(e){
            e.stopPropagation();

            let epList = document.getElementById('eplst');
            epList.innerHTML = "";

            childsCounter = 1;
            childsChildsMap.clear();

            localStorage.removeItem(STORAGE_KEY);

            document.getElementById('click-note')
                .classList.remove('display-none');
        }

        /* --------------------------
        STORAGE
        ---------------------------*/

        function saveToStorage(){
            const treeData = serializeTree();
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                counter: childsCounter,
                tree: treeData
            }));
        }

        function loadFromStorage(){
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            const data = JSON.parse(saved);

            childsCounter = data.counter || 1;

            if (data.tree && data.tree.length > 0){
                document.getElementById('click-note')
                    .classList.add('display-none');

                rebuildTree(data.tree);
            }
        }

        function serializeTree(){
            const root = document.getElementById('eplst');
            const nodes = [];

            root.querySelectorAll(':scope > li').forEach(li => {
                nodes.push(serializeNode(li));
            });

            return nodes;
        }

        function serializeNode(li){
            const nodeData = {
                text: li.firstChild.textContent,
                color: li.dataset.color,
                children: []
            };

            const childUl = li.querySelector(':scope > ul');
            if (childUl){
                childUl.querySelectorAll(':scope > li').forEach(child => {
                    nodeData.children.push(serializeNode(child));
                });
            }

            return nodeData;
        }

        function rebuildTree(tree){
            const root = document.getElementById('eplst');
            root.innerHTML = "";
            childsChildsMap.clear();

            tree.forEach(node => {
                root.appendChild(rebuildNode(node));
            });
        }

        function rebuildNode(nodeData){
            const li = createNode(nodeData.text, nodeData.color);

            if (nodeData.children && nodeData.children.length > 0){
                const ul = document.createElement('ul');

                nodeData.children.forEach(child => {
                    ul.appendChild(rebuildNode(child));
                });

                li.appendChild(ul);
            }

            return li;
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>